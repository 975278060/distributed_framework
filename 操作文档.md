## 1、操作步骤

### 1.1、写好你自己的业务函数，这一步与消费框架无关。
例如：
~~~
def add(x,y):
    print(f'{x} + {y} = {x + y}')
    return x + y
~~~

### 1.2、将函数传给消费框架，并启动执行。
~~~
# 1.2.1 导入生成各种不同类型中间件的consumer的工厂函数。
from function_scheduling_distributed_framework import get_consumer,patch_frame_config,ConsumersManager

# 1.2.2 例如当你使用redis作为中间件，则需要配置redis的账号密码 ip等。
patch_frame_config(REDIS_HOST='127.0.0.1',
                       REDIS_PASSWORD='123456',
                       REDIS_PORT=6379,
                       REDIS_DB=7,)

# 1.2.3 实例化生成一个消费者,这里生成的是redis为中间件，可确认消费的消费者。更多的函数运行控制见readme的说明。
consumer_add = get_consumer('queue_test569', consuming_function=add, broker_kind=9)

# 1.2.4 开启并发消费,默认是在一个新的线程里面开始循环调度任务消费，所以当前主线程下，
#       可以在当前主线程连续对多个consumer实例执行start_consuming_message方法，同时消费多个队列和执行相应的函数。
ConsumersManager.show_all_consumer_info() # 这行是显示所有注册的消费者信息，可以不执行。
consumer_add.start_consuming_message()

# 1.2.5 发布一个任务到中间件，一般推送是写在另外的脚本。这里写在一起。
consumer_add.publisher_of_same_queue.publish(dict(x=1,y=2))     

# 1.2.5.2 发布一个任务到中间件，并且使用同步的方式等待结果返回。
async_result = consumer_add.publisher_of_same_queue.publish(dict(x=3,y=4),
               independence_control_config=IndependenceFuctionConsumingControlConfig(is_using_rpc_mode=True))
print(async_result.result)
~~~ 


## 2、运行结果
~~~
ssh://root@112.90.89.16:10033/data/miniconda3dir/inner/envs/mtfy/bin/python -u /home/ydf/distributed_framework/test_frame/my/test.py
"/home/ydf/distributed_framework/function_scheduling_distributed_framework/utils/decorators.py:26"  17:25:55   操作系统类型是  posix
2020-01-02 17:25:55 - ConcurrentModeDispatcher - "/home/ydf/distributed_framework/function_scheduling_distributed_framework/consumers/base_consumer.py:548" - __init__ - WARNING -  队列为 queue_test569 函数为 <function add at 0x7f1a4e8d9e18> 的消费者 设置并发模式为thread
17:25:55 "/home/ydf/distributed_framework/test_frame/my/test.py:27"  此行 实例化队列名 queue_test569 的消费者, 类型为 <class 'function_scheduling_distributed_framework.consumers.redis_consumer_ack_able.RedisConsumerAckAble'>
"/home/ydf/distributed_framework/function_scheduling_distributed_framework/consumers/base_consumer.py:168"  17:25:55  当前解释器内，所有消费者的信息是：
  {
    "queue_test569": {
        "is_using_rpc_mode": false,
        "function_result_status_persistance_conf": {
            "is_save_status": false,
            "is_save_result": false,
            "expire_seconds": 604800
        },
        "schedule_tasks_on_main_thread": false,
        "do_not_run_by_specify_time": [
            "10:00:00",
            "22:00:00"
        ],
        "is_do_not_run_by_specify_time_effect": false,
        "is_consuming_function_use_multi_params": true,
        "task_filtering_expire_seconds": 0,
        "do_task_filtering": false,
        "create_logger_file": true,
        "logger_prefix": "",
        "msg_expire_senconds": 0,
        "qps": 0,
        "msg_schedule_time_intercal": 0.0,
        "is_print_detail_exception": true,
        "log_level": 10,
        "max_retry_times": 3,
        "concurrent_mode": 1,
        "specify_threadpool": null,
        "threads_num": 50,
        "function_timeout": 0,
        "consuming_function": "<function add at 0x7f1a4e8d9e18>",
        "queue_name": "queue_test569",
        "broker_kind": 9,
        "class_name": "RedisConsumerAckAble",
        "concurrent_mode_name": "thread",
        "where_to_instantiate": "/home/ydf/distributed_framework/test_frame/my/test.py:27"
    }
}
17:25:55 "/home/ydf/distributed_framework/test_frame/my/test.py:27"  queue_test569 的消费者
2020-01-02 17:25:55 - RedisConsumerAckAble--thread--queue_test569 - "/home/ydf/distributed_framework/function_scheduling_distributed_framework/consumers/base_consumer.py:411" - start_consuming_message - WARNING -  开始消费 queue_test569 中的消息
2020-01-02 17:25:55 - RedisPublisher--queue_test569 - "/home/ydf/distributed_framework/function_scheduling_distributed_framework/publishers/base_publisher.py:92" - __init__ - INFO -  <class 'function_scheduling_distributed_framework.publishers.redis_publisher.RedisPublisher'> 被实例化了
2020-01-02 17:25:55 - RedisConsumerAckAble--thread--queue_test569 - "/home/ydf/distributed_framework/function_scheduling_distributed_framework/consumers/base_consumer.py:495" - check_heartbeat_and_message_count - INFO -  [queue_test569] 队列中还有 [0] 个任务
2020-01-02 17:25:55 - RedisPublisher--queue_test569 - "/home/ydf/distributed_framework/function_scheduling_distributed_framework/publishers/base_publisher.py:122" - publish - DEBUG -  向queue_test569 队列，推送消息 耗时0.0012秒  {'x': 1, 'y': 2, 'extra': {'task_id': 'queue_test569_result:5e418ca5-ce06-4401-bd3f-32b098e4b7bc', 'publish_time': 1577957155.5095, 'publish_time_format': '2020-01-02 17:25:55'}}
2020-01-02 17:25:55 - RedisConsumerAckAble--thread--queue_test569 - "/home/ydf/distributed_framework/function_scheduling_distributed_framework/consumers/redis_consumer_ack_able.py:25" - _shedual_task - DEBUG -  从redis的 [queue_test569] 队列中 取出的消息是：     {"x": 1, "y": 2, "extra": {"task_id": "queue_test569_result:5e418ca5-ce06-4401-bd3f-32b098e4b7bc", "publish_time": 1577957155.5095, "publish_time_format": "2020-01-02 17:25:55"}}  
2020-01-02 17:25:55 - RedisPublisher--queue_test569 - "/home/ydf/distributed_framework/function_scheduling_distributed_framework/publishers/base_publisher.py:122" - publish - DEBUG -  向queue_test569 队列，推送消息 耗时0.0003秒  {'x': 3, 'y': 4, 'extra': {'task_id': 'queue_test569_result:6a1c31b0-d36d-47ef-b401-60a05225f400', 'publish_time': 1577957155.5111, 'publish_time_format': '2020-01-02 17:25:55', 'function_timeout': None, 'max_retry_times': None, 'is_print_detail_exception': None, 'msg_expire_senconds': None, 'is_using_rpc_mode': True}}
2020-01-02 17:25:55 - FunctionResultChche - "/home/ydf/distributed_framework/function_scheduling_distributed_framework/utils/decorators.py:420" - __cached_function_result_for_a_time - DEBUG -  函数 [_judge_is_daylight] 此次不能使用缓存
2020-01-02 17:25:55 - CustomThreadPoolExecutor - "/home/ydf/distributed_framework/function_scheduling_distributed_framework/concurrent_pool/custom_threadpool_executor.py:97" - _adjust_thread_count - DEBUG -  (0, 0, 0, 5)
2020-01-02 17:25:55 - _CustomThread - "/home/ydf/distributed_framework/function_scheduling_distributed_framework/concurrent_pool/custom_threadpool_executor.py:140" - run - DEBUG -  新启动线程 139750725875456 
"/home/ydf/distributed_framework/test_frame/my/test.py:11"  17:25:55  1 + 2 = 3
2020-01-02 17:25:55 - RedisConsumerAckAble--thread--queue_test569 - "/home/ydf/distributed_framework/function_scheduling_distributed_framework/consumers/base_consumer.py:468" - _run_consuming_function_with_confirm_and_retry - DEBUG -   函数 add  第1次 运行, 正确了，函数运行时间是 0.0001 秒,入参是 【 {'x': 1, 'y': 2} 】。  [<_CustomThread(Thread-5, started daemon 139750725875456)>  6]
2020-01-02 17:25:55 - RedisConsumerAckAble--thread--queue_test569 - "/home/ydf/distributed_framework/function_scheduling_distributed_framework/consumers/redis_consumer_ack_able.py:25" - _shedual_task - DEBUG -  从redis的 [queue_test569] 队列中 取出的消息是：     {"x": 3, "y": 4, "extra": {"task_id": "queue_test569_result:6a1c31b0-d36d-47ef-b401-60a05225f400", "publish_time": 1577957155.5111, "publish_time_format": "2020-01-02 17:25:55", "function_timeout": null, "max_retry_times": null, "is_print_detail_exception": null, "msg_expire_senconds": null, "is_using_rpc_mode": true}}  
2020-01-02 17:25:55 - CustomThreadPoolExecutor - "/home/ydf/distributed_framework/function_scheduling_distributed_framework/concurrent_pool/custom_threadpool_executor.py:97" - _adjust_thread_count - DEBUG -  (1, 1, 1, 6)
"/home/ydf/distributed_framework/test_frame/my/test.py:11"  17:25:55  3 + 4 = 7
2020-01-02 17:25:55 - _CustomThread - "/home/ydf/distributed_framework/function_scheduling_distributed_framework/concurrent_pool/custom_threadpool_executor.py:140" - run - DEBUG -  新启动线程 139750724822784 
2020-01-02 17:25:55 - RedisConsumerAckAble--thread--queue_test569 - "/home/ydf/distributed_framework/function_scheduling_distributed_framework/consumers/base_consumer.py:468" - _run_consuming_function_with_confirm_and_retry - DEBUG -   函数 add  第1次 运行, 正确了，函数运行时间是 0.0004 秒,入参是 【 {'x': 3, 'y': 4} 】。  [<_CustomThread(Thread-5, started daemon 139750725875456)>  7]
"/home/ydf/distributed_framework/test_frame/my/test.py:40"  17:25:55  7
2020-01-02 17:26:55 - RedisConsumerAckAble--thread--queue_test569 - "/home/ydf/distributed_framework/function_scheduling_distributed_framework/consumers/base_consumer.py:495" - check_heartbeat_and_message_count - INFO -  [queue_test569] 队列中还有 [0] 个任务
2020-01-02 17:27:55 - RedisConsumerAckAble--thread--queue_test569 - "/home/ydf/distributed_framework/function_scheduling_distributed_framework/consumers/base_consumer.py:495" - check_heartbeat_and_message_count - INFO -  [queue_test569] 队列中还有 [0] 个任务
2020-01-02 17:28:55 - RedisConsumerAckAble--thread--queue_test569 - "/home/ydf/distributed_framework/function_scheduling_distributed_framework/consumers/base_consumer.py:495" - check_heartbeat_and_message_count - INFO -  [queue_test569] 队列中还有 [0] 个任务


~~~
